name: Neovim Startuptime

on:
  push:
    branches:
      - 'main'
  pull_request:

env:
  GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

jobs:
  macos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Neovim
        id: 'neovim'
        uses: thinca/action-setup-vim@v3
        with:
          vim_version: 'stable'
          vim_type: 'Neovim'
      - name: Show Vim version
        run: |
          ${{ steps.neovim.outputs.executable }} --version
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 'stable'
          # disable cache as this repository does not have go.sum.
          cache: false
      - name: Setup vim-startuptime
        run: |
          go install github.com/rhysd/vim-startuptime@latest
      - name: Setup init.lua
        run: |
          cp -rf ./config/nvim ~/.config
      - name: Run vim-startuptime
        run: |
          vim-startuptime \
            -vimpath "${{ steps.neovim.outputs.executable }}" \
            -count 100 \
            -warmup 10 \
            -script \
            >> output.txt
          echo "total_average_time=$(grep 'Total Average:' output.txt | awk '{printf "%.2f %s", $3, $4}')" >> "$GITHUB_ENV"
      - name: Update badge
        run: |
          content=$(
            printf '{"schemaVersion":1,"style":"for-the-badge","label":"startuptime","message":"%s","logoColor":"#019733","color":"brightgreen","namedLogo":"neovim"}' \
              "${{ env.total_average_time }}"
          )
          escaped_content=$(echo "$content" | sed 's/"/\\"/g' | tr -d '\n')
          json_payload=$(printf '{"files":{"vim-startuptime.json":{"content":"%s"}}}' "$escaped_content")
          curl -s -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GIST_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/093763e63c107ab23ebef0133c42e039" \
            -d "$json_payload"
      - name: Create GitHub Step Summary
        run: |
          {
            echo '### Neovim Startup Time Result ðŸš€'
            echo "| AVERAGE   | MAX     | MIN     | FILE        |"
            echo "|-----------|---------|---------|-------------|"
          } >> "$GITHUB_STEP_SUMMARY"
          # extract the necessary lines from the output and process them in Markdown format.
          grep -E '^[[:space:]]*[0-9]' "output.txt" | while read -r line; do
            echo "$line"
            average=$(echo "$line" | awk '{print $1}')
            max=$(echo "$line" | awk '{print $2}')
            min=$(echo "$line" | awk '{print $3}' | sed 's/:$//')
            file=$(echo "$line" | awk '{$1=$2=$3=""; print $0}' | sed 's/^ *//')
            echo "| ${average} | ${max} | ${min} | ${file} |" >> "$GITHUB_STEP_SUMMARY"
          done
